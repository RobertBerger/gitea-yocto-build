name: release-uninative-local-source-mirror

#on: [push]

on:
  workflow_call:

jobs:
  release-uninative-local-source-mirror-job:
    # runs-on: yocto-build-latest
    # runs-on: 2023-05-24-master-local-icecc-ub20-doc-action
    runs-on: yocto-build-walnascar
    # The timeout for a job to be finished.
    # Please note that the Gitea instance also has a timeout (3h by default) for the job.
    # So the job could be stopped by the Gitea instance if it's timeout is shorter than this.
    # Specify location to build, this path persists across builds allowing
    # us to build incrementally
    env:
       WORK_DIR: ${{github.workspace}}/workdir
       GITEA_GIT_MIRROR: 192.168.42.182:8939
       GITEA_SERVER: 192.168.42.182:8940
       WORKFLOW_DIR: gitea-yocto-build
       WORKFLOW_REPO: rber/${{env.WORKFLOW_DIR}}
       MANIFEST_REPO: rber/manifests -b master-action-walnascar
       YP_CONFIG: multi-v7-ml-debug-training-master
       META_RESY: meta-resy-master
       TEMPLATE_COMMON: template-common-master
       YP_VERSION: walnascar
       #ARTIFACTS_ON_SERVER: /appdata/artifacts/workspace/rber/${{env.WORKFLOW_DIR}}/workdir/artifacts
       ARTIFACTS_ON_SERVER: /appdata/artifacts
       NO_SSTATE_MIRRORS: yes
       USE_SSTATE_MIRRORS: no
       USE_SSTATE_MIRRORS_LOCAL: no
       # to populate the sstate mirror:
       POPULATE_SSTATE_MIRROR: no
       NO_IMAGE_BUILDINFO: yes
       NON_DEFAULT_XZ_PARAMS: no
       # used for local source mirror:
       USE_VAR_WWW_SOURCES: no
       USE_VAR_WWW_SSTATE: no
       PREP_SOURCE_MIRROR: no
       # --> only one yes, the other no
       NO_SOURCE_MIRROR: yes
       USE_SOURCE_MIRROR: no
       USE_SOURCE_MIRROR_LOCAL: yes
       # <-- only one yes, the other no
       USE_BB_NO_NETWORK: yes
       USE_BB_ALLOWED_NETWORKS: no
       THE_ALLOWED_NETWORKS: 192.168.42.182
       # --> only one yes, the other no
       NO_PREMIRRORS: yes
       USE_PREMIRRORS: no
       # <-- only one yes, the other no 
       # --> only one yes, the other no
       BUILD_UNINATIVE_TARBALL: yes
       USE_UNINATIVE_TARBALL: no
       USE_UNINATIVE_TARBALL_LOCAL: no
       DONT_USE_UNINATIVE_TARBALL: yes
       POPULATE_UNINATIVE_TARBALL: yes
       UNINATIVE_TARBALL_VERSION: 4.6
       # <-- only one yes, the other no
       THE_UNINATIVE_URL: http://${{env.WEB_SERVER}}/releases/uninative/${{env.UNINATIVE_TARBALL_VERSION}}/
       THE_UNINATIVE_LOCAL_URL: file:///${{env.WORK_DIR}}/uninative/${{env.UNINATIVE_TARBALL_VERSION}}/
       THE_SOURCE_MIRROR_URL: http://${{env.WEB_SERVER}}/source_mirror_${{env.YP_VERSION}}
       THE_SSTATE_MIRROR_URL: http://${{env.WEB_SERVER}}/sstate_mirror_${{env.YP_VERSION}}
       USE_PR_SERVER: yes
       PR_SERVER: 192.168.42.182:18586
       USE_HASH_SERVER: yes
       HASH_SERVER: 192.168.42.182:8688
       # lighttpd:
       WEB_SERVER: 192.168.42.182:8941
       # nginx:
       #WEB_SERVER: 10.0.0.182:8053
       BITBAKE_ZERO: uninative-tarball
       #BITBAKE_ZERO: 'uninative-tarball --runall=fetch'
       BITBAKE_ZERO_ALLOW_ERROR: no
       #BITBAKE_ONE: core-image-minimal
       #BITBAKE_ONE: 'core-image-minimal --runall=fetch'
       BITBAKE_ONE: empty
       BITBAKE_ONE_ALLOW_ERROR: no
       BITBAKE_TWO: empty
       BITBAKE_TWO_ALLOW_ERROR: no
       NOTE: uninative-local-source-mirror
    #name: Yocto build - core-image-minimal-local-source-mirror
    steps:
      - name: Get build system info
        id: build_system
        run: |
          echo "Host: ${HOSTNAME}"
          echo "CPUs/Threads: $(grep -c ^processor /proc/cpuinfo)"
          echo "CPUs: $(grep ^cpu\\scores /proc/cpuinfo | uniq |  awk '{print $4}')"
          echo "$(free -mh)"
          echo "$(id)"
      - name: Get current date/time
        id: date
        run: |
          echo "::set-output name=date::$(date +'%Y%m%d%H%M%S')"
      - name: Get gitea git mirror
        id: gitea_git_mirror
        run: |
          echo "::set-output name=gitea_git_mirror::${{env.GITEA_GIT_MIRROR}}"
      - name: Get gitea server
        id: gitea_server
        run: |
          echo "::set-output name=gitea_server::${{env.GITEA_SERVER}}"
      - name: Get workflow repo
        id: workflow_repo
        run: |
          echo "::set-output name=workflow_repo::${{env.WORKFLOW_REPO}}"
      - name: Get manifest repo
        id: manifest_repo
        run: |
          echo "::set-output name=manifest_repo::${{env.MANIFEST_REPO}}"
      - name: Get META_RESY
        id: meta_resy
        run: |
          echo "::set-output name=meta_resy::${{env.META_RESY}}"
      - name: Get TEMPLATE_COMMON
        id: template_comomon
        run: |
          echo "::set-output name=template_common::${{env.TEMPLATE_COMMON}}"
      - name: Get Yocto Project config
        id: yp_config
        run: |
          echo "::set-output name=yp_config::${{env.YP_CONFIG}}"
      - name: get Yocto Project version
        id: yp_version
        run: |
          echo "::set-output name=yp_version::${{env.YP_VERSION}}"
      - name: get PR server
        id: pr_server
        run: |
          echo "::set-output name=pr_server::${{env.PR_SERVER}}"
      - name: get hash server
        id: hash_server
        run: |
          echo "::set-output name=hash_server::${{env.HASH_SERVER}}"
      - name: get web server
        id: web_server
        run: |
          echo "::set-output name=web_server::${{env.WEB_SERVER}}"
      - name: get THE_UNINATIVE_URL
        id: uninative_url
        run: |
          echo "::set-output name=uninative_url::${{env.THE_UNINATIVE_URL}}"
      - name: get THE_SOURCE_MIRROR_URL
        id: source_mirror_url
        run: |
          echo "::set-output name=source_mirror_url::${{env.THE_SOURCE_MIRROR_URL}}"
      - name: get THE_SSTATE_MIRROR_URL
        id: sstate_mirror_url
        run: |
          echo "::set-output name=sstate_mirror_url::${{env.THE_SSTATE_MIRROR_URL}}"
      - name: get Note
        id: note
        run: |
          echo "::set-output name=note::${{env.NOTE}}"
      - name: Get bitbake_zero
        id: bitbake_zero
        run: |
          echo "::set-output name=bitbake_zero::${{env.BITBAKE_ZERO}}"
      - name: Get bitbake_one
        id: bitbake_one
        run: |
          echo "::set-output name=bitbake_one::${{env.BITBAKE_ONE}}"
      - name: Get bitbake_two
        id: bitbake_two
        run: |
          echo "::set-output name=bitbake_two::${{env.BITBAKE_TWO}}"
      - name: Get bitbake_three
        id: bitbake_three
        run: |
          echo "::set-output name=bitbake_three::${{env.BITBAKE_THREE}}"
      - name: Get bitbake_four
        id: bitbake_four
        run: |
          echo "::set-output name=bitbake_four::${{env.BITBAKE_FOUR}}"
      - name: Get the_allowed_networks
        id: the_allowed_networks
        run: |
          echo "::set-output name=the_allowed_networks::${{env.THE_ALLOWED_NETWORKS}}"
      - name: Checkout workflow repo
        run: |
          mkdir -p ${{env.WORK_DIR}}/sources
          pushd ${{env.WORK_DIR}}/sources
          git clone http://${{ steps.gitea_server.outputs.gitea_server }}/${{ steps.workflow_repo.outputs.workflow_repo }}
          ls
          popd
      - name: Checkout manifest repo
        run: |
          mkdir -p ${{env.WORK_DIR}}/sources
          pushd ${{env.WORK_DIR}}/sources
          git clone http://${{ steps.gitea_server.outputs.gitea_server }}/${{ steps.manifest_repo.outputs.manifest_repo }}
          ls
          popd
      - name: Create symlinks
        run: |
          cd ${{env.WORK_DIR}}
          ln -sf sources/manifests/resy-cooker.sh resy-cooker.sh
          ln -sf sources/manifests/killall_bitbake.sh killall_bitbake.sh
          ln -sf sources/manifests/resy-${{ steps.yp_config.outputs.yp_config }}.sh resy-${{ steps.yp_config.outputs.yp_config }}.sh
          pwd
          ls
      - name: Checkout repos for ${{ env.YP_CONFIG }}
        run: |
          pushd ${{env.WORK_DIR}}
          ls
          ./resy-${{ steps.yp_config.outputs.yp_config }}.sh
          #tree -L 1 sources
          popd
        env:
          # export WORKDIR to resy-cooker.sh script:
          WORKDIR: ${{ env.WORK_DIR }}
          WORKSPACE: "jenkins"
      - name: Fix broken links
        run: |
          pushd ${{env.WORK_DIR}}
          echo "--> broken links"
          find . -xtype l -ls
          echo "<-- broken links"
          echo "--> fix links"
          find . -xtype l -exec bash -c 'target="$(readlink "{}")"; link="{}"; target="$(echo "$target" | sed "s,/workdir,${{ env.WORK_DIR }},g")"; ln -Tfs "$target" "$link"' \;
          echo "<-- fix links"
          echo "--> broken links"
          find . -xtype l -ls
          echo "<-- broken links"
          popd
        env:
          # export WORKDIR to resy-cooker.sh script:
          WORKDIR: ${{ env.WORK_DIR }}
          WORKSPACE: "jenkins"
      - name: Fix site.conf file
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          sed -i "s,/workdir,${{ env.WORK_DIR }}," site.conf
          sed -i "s,/mirror/,/${{ steps.web_server.outputs.web_server }}/," site.conf
          sed -i "s,/mirror.res.training,/${{ steps.web_server.outputs.web_server }}/," site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - hash server
        if: ${{ env.USE_HASH_SERVER == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          sed -i "s,mirror:8687,${{ steps.hash_server.outputs.hash_server }}," site.conf
          sed -i 's/^BB_HASHSERVE_UPSTREAM/#&/' site.conf
          echo "BB_HASHSERVE_UPSTREAM=\"${{ env.HASH_SERVER }}\"" >> site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - no SSTATE/MIRRORS,...
        if: ${{ env.NO_SSTATE_MIRRORS == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          sed -i 's/^SSTATE_MIRRORS/#&/' site.conf
          sed -i 's/^BB_HASHSERVE_UPSTREAM/#&/' site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - use SSTATE/MIRRORS http://,...
        if: ${{ env.USE_SSTATE_MIRRORS == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          sed -i 's/^SSTATE_MIRRORS/#&/' site.conf
          # SSTATE_MIRRORS = "file://.* http://***:8941/sstate_mirror_master/PATH;downloadfilename=PATH"
          echo "SSTATE_MIRRORS=\"file://.* ${{ env.THE_SSTATE_MIRROR_URL }}/PATH;downloadfilename=PATH\"" >> site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - use SSTATE/MIRRORS file://,...
        if: ${{ env.USE_SSTATE_MIRRORS_LOCAL == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          sed -i 's/^SSTATE_MIRRORS/#&/' site.conf
          # SSTATE_MIRRORS = "file://.* http://***:8941/sstate_mirror_master/PATH;downloadfilename=PATH"
          echo "SSTATE_MIRRORS=\"file://.* ${{ env.THE_SSTATE_MIRROR_URL }}/PATH;downloadfilename=PATH\"" >> site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - prep. build uninative-tarball
        if: ${{ env.BUILD_UNINATIVE_TARBALL == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          # I guess we need my uninative tarball URL to build the uninative tarball
          sed -i 's/^UNINATIVE_URL/#&/' site.conf
          echo "UNINATIVE_TARBALL=\"\"" >> site.conf
          # echo "UNINATIVE_CHECKSUM[x86_64]=\"deadbeef\"" >> site.conf
          # SRC_URI[sha256sum] = "8a6e588cc3435b9d9c87845b931ed17df7956eed29fd171aec05fbc557da6e7a"
          echo "UNINATIVE_CHECKSUM[x86_64]=\"954182f691bb2dbae157ee991654ad2fd4cb51c7f3d3ab429e9f84654c8dc990\"" >> site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - use uninative-tarball
        if: ${{ env.USE_UNINATIVE_TARBALL == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          echo "${{ steps.uninative_url.outputs.uninative_url }}/sha256sum.txt"
          time wget -t 2 -T 30 --passive-ftp "${{ steps.uninative_url.outputs.uninative_url }}/sha256sum.txt"
          cat sha256sum.txt
          UNINATIVE_SHA256SUM=$(cat sha256sum.txt)
          echo "uninative_sha256sum: ${UNINATIVE_SHA256SUM}"
          echo "UNINATIVE_CHECKSUM[x86_64]=\"${UNINATIVE_SHA256SUM}\"" >> site.conf
          # -----> this might be needed here (since it's not build from local sources)
          # let's comment out the UNINATIVE_URL first
          sed -i 's/^UNINATIVE_URL/#&/' site.conf
          # let's set the UNINATIVE_URL
          echo "UNINATIVE_URL=\"${{ env.THE_UNINATIVE_URL }}\"" >> site.conf
          # <----- this might be needed here (since it's not build from local sources)
          cat site.conf
          popd
      - name: Fix site.conf file - use uninative-tarball local
        if: ${{ env.USE_UNINATIVE_TARBALL_LOCAL == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          echo "${{ steps.uninative_url.outputs.uninative_url }}/sha256sum.txt"
          time wget -t 2 -T 30 --passive-ftp "${{ steps.uninative_url.outputs.uninative_url }}/sha256sum.txt"
          cat sha256sum.txt
          UNINATIVE_SHA256SUM=$(cat sha256sum.txt)
          echo "uninative_sha256sum: ${UNINATIVE_SHA256SUM}"
          echo "UNINATIVE_CHECKSUM[x86_64]=\"${UNINATIVE_SHA256SUM}\"" >> site.conf
          # -----> this might not be needed here (since it's build from local sources)
          # let's comment out the UNINATIVE_URL first
          sed -i 's/^UNINATIVE_URL/#&/' site.conf
          # let's set the UNINATIVE_LOCAL_URL
          echo "UNINATIVE_URL=\"${{ env.THE_UNINATIVE_LOCAL_URL }}\"" >> site.conf
          # <----- this might not be needed here (since it's build from local sources)
          cat site.conf
          popd
      - name: Fix site.conf file - don't use uninative-tarball
        if: ${{ env.DONT_USE_UNINATIVE_TARBALL == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          sed -i 's/^UNINATIVE_URL/#&/' site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - PR server
        if: ${{ env.USE_PR_SERVER == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          sed -i "s,localhost:0,${{ steps.pr_server.outputs.pr_server }}," site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - no PREMIRRORS
        if: ${{ env.NO_PREMIRRORS == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          sed -i "/PREMIRRORS +=/,+5 s/^/#/" site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - use PREMIRRORS
        if: ${{ env.USE_PREMIRRORS == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          # we comment out the previous PREMIRRORS
          sed -i "/PREMIRRORS +=/,+5 s/^/#/" site.conf
          # we add our new PREMIRRORS
          # PREMIRRORS += " \
          # git://git.denx.de/u-boot.git git://omv-1:8939/robert.berger/u-boot.git;protocol=http \n \
          # git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git git://omv-1:8939/robert.berger/linux-stable.git;protocol=http \n \
          # git://git.yoctoproject.org/linux-yocto.git git://omv-1.res.training:8939/robert.berger/linux-yocto.git;protocol=http \n \
          # git://git.yoctoproject.org/yocto-kernel-cache git://omv-1:8939/robert.berger/yocto-kernel-cache.git;protocol=http \n \
          # git://github.com/raspberrypi/linux.git git://omv-1:8939/robert.berger/raspberrypi-linux.git;protocol=http \n \
          #"
          echo "PREMIRRORS += \" \\" >> site.conf
          echo "git://git.denx.de/u-boot.git git://${{ steps.gitea_git_mirror.outputs.gitea_git_mirror }}/robert.berger/u-boot.git;protocol=http \\n \\" >> site.conf
          echo "git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git git://${{ steps.gitea_git_mirror.outputs.gitea_git_mirror }}/robert.berger/linux-stable.git;protocol=http \\n \\" >> site.conf
          echo "git://git.yoctoproject.org/linux-yocto.git git://${{ steps.gitea_git_mirror.outputs.gitea_git_mirror }}/robert.berger/linux-yocto.git;protocol=http \\n \\" >> site.conf
          echo "git://git.yoctoproject.org/yocto-kernel-cache git://${{ steps.gitea_git_mirror.outputs.gitea_git_mirror }}/robert.berger/yocto-kernel-cache.git;protocol=http \\n \\" >> site.conf
          echo "git://github.com/raspberrypi/linux.git git://${{ steps.gitea_git_mirror.outputs.gitea_git_mirror }}/robert.berger/raspberrypi-linux.git;protocol=http \\n \\" >> site.conf
          echo "\"" >> site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - non default xz params
        if: ${{ env.NON_DEFAULT_XZ_PARAMS == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          echo "SDK_XZ_COMPRESSION_LEVEL = \"-1\"" >> site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - no image-buildinfo
        if: ${{ env.NO_IMAGE_BUILDINFO == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          sed -i "s,image-buildinfo,," site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - no SOURCE_MIRROR
        if: ${{ env.NO_SOURCE_MIRROR == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          #sed -i 's/^BB_GENERATE_MIRROR_TARBALLS/#&/' site.conf
          sed -i 's/^SOURCE_MIRROR_URL/#&/' site.conf
          sed -i "s,own-mirrors,," site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - use SOURCE_MIRROR
        if: ${{ env.USE_SOURCE_MIRROR == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          #sed -i 's/^BB_GENERATE_MIRROR_TARBALLS/#&/' site.conf
          #sed -i 's/^SOURCE_MIRROR_URL/#&/' site.conf
          #sed -i "s,own-mirrors,," site.conf
          echo "INHERIT += \"own-mirrors\"" >> site.conf
          # SOURCE_MIRROR_URL = "http://example.com/my-source-mirror"
          # remove the source mirror
          sed -i 's/^SOURCE_MIRROR_URL/#&/' site.conf
          echo "SOURCE_MIRROR_URL = \"http://${{env.THE_SOURCE_MIRROR_URL}}\"" >> site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - use SOURCE_MIRROR_LOCAL
        if: ${{ env.USE_SOURCE_MIRROR_LOCAL == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          #sed -i 's/^BB_GENERATE_MIRROR_TARBALLS/#&/' site.conf
          sed -i 's/^SOURCE_MIRROR_URL/#&/' site.conf
          #sed -i "s,own-mirrors,," site.conf
          # SOURCE_MIRROR_URL syntax: 
          # SOURCE_MIRROR_URL ?= "file:///workdir/source_mirror_langdale/"
          # 3 - Three slashes
          echo "INHERIT += \"own-mirrors\"" >> site.conf
          echo "SOURCE_MIRROR_URL = \"file://${{env.WORK_DIR}}/source_mirror/\"" >> site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - BB_NO_NETWORK
        if: ${{ env.USE_BB_NO_NETWORK == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          echo "BB_NO_NETWORK = \"1\"" >> site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - BB_ALLOWED_NETWORKS
        if: ${{ env.USE_BB_ALLOWED_NETWORKS == 'yes' }}
        run: |
          pushd ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }}
          echo "BB_ALLOWED_NETWORKS = \"${{ env.THE_ALLOWED_NETWORKS }}\"" >> site.conf
          cat site.conf
          popd
      - name: Fix site.conf file - VAR_WWW_SOURCES - BB_NO_NETWORK needed
        if: ${{ env.USE_VAR_WWW_SOURCES == 'yes' }}
        run: |
          # --> source mirror local
          mkdir -p ${{env.WORK_DIR}}/source_mirror
          pushd ${{env.WORK_DIR}}
          time wget -t 2 -T 30 --passive-ftp 'http://${{ steps.web_server.outputs.web_server }}/source_mirror_${{ steps.yp_version.outputs.yp_version }}_compressed/DL_DIR.tar.gz'
          tar xf DL_DIR.tar.gz -C ${{env.WORK_DIR}}/source_mirror
          if [ ! -d ${{env.WORK_DIR}}/artifacts ];then mkdir -p ${{env.WORK_DIR}}/artifacts ; fi
          cp DL_DIR.tar.gz ${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-source_mirror_${{ steps.yp_version.outputs.yp_version }}_compressed.tar.gz
          rm -f DL_DIR.tar.gz
          #echo "BB_ALLOWED_NETWORKS = \"${{ env.THE_ALLOWED_NETWORKS }}\"" >> site.conf
          #echo "SRCREV:pn-ascii-invaders = \"2644be38afc06f7f7bba55034966dd66d9ad524f\"" >> site.conf
          #cat site.conf
          popd
          # <-- source mirror local
          # --> uninative local
          mkdir -p ${{env.WORK_DIR}}/uninative
          pushd ${{env.WORK_DIR}}/uninative
          time wget -r -nH --cut-dirs=2 --no-parent --reject="index.html*" ${{env.THE_UNINATIVE_URL}}
          tree ${{env.WORK_DIR}}/uninative
          popd
          # <-- uninative local
      # - name: Fix site.conf symlinks
      #   run: |
      #     pushd ${{env.WORK_DIR}}
      #     popd
      #   env: 
      #     # export WORKDIR to resy-cooker.sh script:
      #     WORKDIR: ${{ env.WORK_DIR }}
      #     WORKSPACE: "jenkins"
      - name: Fix site.conf file - VAR_WWW - BB_NO_NETWORK needed - uninative local
        if: ${{ env.USE_UNINATIVE_TARBALL_LOCAL == 'yes' }}
        run: |
          # --> uninative local
          mkdir -p ${{env.WORK_DIR}}/uninative
          pushd ${{env.WORK_DIR}}/uninative
          time wget -r -nH --cut-dirs=2 --no-parent --reject="index.html*" ${{env.THE_UNINATIVE_URL}}
          tree ${{env.WORK_DIR}}/uninative
          popd
          # <-- uninative local      
      - name: Compress Artifacts before build
        run: |
          if [ ! -d ${{env.WORK_DIR}}/artifacts ];then mkdir -p ${{env.WORK_DIR}}/artifacts ; fi
          pushd ${{env.WORK_DIR}}/artifacts
          if [ -d ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }} ];then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-${{ env.META_RESY }}-${{ env.TEMPLATE_COMMON }}.tar.gz -C ${{env.WORK_DIR}}/sources/${{ env.META_RESY }}/${{ env.TEMPLATE_COMMON }} .; fi
          if [ -d ${{env.WORK_DIR}}/sources ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-sources.tar.gz -C ${{env.WORK_DIR}}/sources .; fi
          pwd
          ls -lah ${{env.WORK_DIR}}/artifacts
          popd
####################### --> not supported yet ???
      # - name: Upload Artifact
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: test
      #     path: ${{env.WORK_DIR}}/artifacts
####################### <-- not supported yet ???
      - name: Copy artifacts before build - what is there? (0)
        run: |
          echo "ls ${{env.WORK_DIR}}/artifacts/"
          ls "${{env.WORK_DIR}}/artifacts/"
      # --> cp template-common conditionally
      - name: Check for file template-common
        id: template-common_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-${{ env.META_RESY }}-${{ env.TEMPLATE_COMMON }}.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts before build - template-common (1)
        if: steps.template-common_file_check.outputs.file_exists == 'yes'
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-template-common*.tar.gz"
          dist: /appdata/artifacts
      # <-- cp template-common conditionally
      # --> cp source_mirror_compressed conditionally
      - name: Check for file source_mirror_compressed
        id: source_mirror_compressed_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-source_mirror_${{ steps.yp_version.outputs.yp_version }}_compressed.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts before build - source_mirror_${{env.YP_VERSION}}_compressed (2)
        if: steps.source_mirror_compressed_file_check.outputs.file_exists == 'yes'
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*source_mirror_${{env.YP_VERSION}}_compressed.tar.gz"
          dist: /appdata/artifacts
      # <-- cp source_mirror_compressed conditionally
      # --> cp sources conditionally    
      - name: Check for file source_mirror_compressed
        id: sources_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-sources.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts before build - sources (3)
        if: steps.sources_file_check.outputs.file_exists == 'yes'
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-sources.tar.gz"
          dist: /appdata/artifacts
      # <-- cp sources conditionally    
#######################################  
      # - name: bitbake uninative-tarball
      #   if: ${{ env.BUILD_UNINATIVE_TARBALL == 'yes' }}
      #   run: |
      #     cd ${{env.WORK_DIR}}
      #     time ./resy-cooker.sh ${{ steps.yp_config.outputs.yp_config }} uninative-tarball
      #   env:
      #     # export WORKDIR to resy-cooker.sh script:
      #     WORKDIR: ${{ env.WORK_DIR }}
      #     WORKSPACE: "jenkins"
#######################################
      - name: bitbake ${{ env.BITBAKE_ZERO }}
        run: |
          if [ "$BITBAKE_ZERO" == "empty" ]; then
             echo "BITBAKE_ZERO is $BITBAKE_ZERO"
          else
             echo "BITBAKE_ZERO is $BITBAKE_ZERO"
             cd ${{env.WORK_DIR}}
             if [ "$BITBAKE_ZERO_ALLOW_ERROR" == "yes" ]; then
                # allow error:
                time ./resy-cooker.sh ${{ steps.yp_config.outputs.yp_config }} ${{ steps.bitbake_zero.outputs.bitbake_zero }} || true
             else
                # don't allow error:
                time ./resy-cooker.sh ${{ steps.yp_config.outputs.yp_config }} ${{ steps.bitbake_zero.outputs.bitbake_zero }}
             fi
          fi
        env:
          # export WORKDIR to resy-cooker.sh script:
          WORKDIR: ${{ env.WORK_DIR }}
          WORKSPACE: "jenkins"
          BITBAKE_ZERO: ${{ env.BITBAKE_ZERO }}
          BITBAKE_ZERO_ALLOW_ERROR: ${{ env.BITBAKE_ZERO_ALLOW_ERROR }}
#######################################
      - name: bitbake ${{ env.BITBAKE_ONE }}
        run: |
          if [ "$BITBAKE_ONE" == "empty" ]; then
             echo "BITBAKE_ONE is $BITBAKE_ONE"
          else
             echo "BITBAKE_ONE is $BITBAKE_ONE"
             cd ${{env.WORK_DIR}}
             if [ "$BITBAKE_ONE_ALLOW_ERROR" == "yes" ]; then
                # allow error:
                time ./resy-cooker.sh ${{ steps.yp_config.outputs.yp_config }} ${{ steps.bitbake_one.outputs.bitbake_one }} || true
             else
                # don't allow error:
                time ./resy-cooker.sh ${{ steps.yp_config.outputs.yp_config }} ${{ steps.bitbake_one.outputs.bitbake_one }}
             fi
          fi
        env:
          # export WORKDIR to resy-cooker.sh script:
          WORKDIR: ${{ env.WORK_DIR }}
          WORKSPACE: "jenkins"
          BITBAKE_ONE: ${{ env.BITBAKE_ONE }}
          BITBAKE_ONE_ALLOW_ERROR: ${{ env.BITBAKE_ONE_ALLOW_ERROR }}
#######################################
      - name: bitbake ${{ env.BITBAKE_TWO }}
        run: |
          if [ "$BITBAKE_TWO" == "empty" ]; then
             echo "BITBAKE_TWO is $BITBAKE_TWO"
          else
             echo "BITBAKE_TWO is $BITBAKE_TWO"
             cd ${{env.WORK_DIR}}
             if [ "$BITBAKE_TWO_ALLOW_ERROR" == "yes" ]; then
                # allow error:
                time ./resy-cooker.sh ${{ steps.yp_config.outputs.yp_config }} ${{ steps.bitbake_two.outputs.bitbake_two }} || true
             else
                # don't allow error:
                time ./resy-cooker.sh ${{ steps.yp_config.outputs.yp_config }} ${{ steps.bitbake_two.outputs.bitbake_two }}
             fi
          fi
        env:
          # export WORKDIR to resy-cooker.sh script:
          WORKDIR: ${{ env.WORK_DIR }}
          WORKSPACE: "jenkins"
          BITBAKE_TWO: ${{ env.BITBAKE_TWO }}
          BITBAKE_TWO_ALLOW_ERROR: ${{ env.BITBAKE_TWO_ALLOW_ERROR }}
#######################################
      - name: bitbake ${{ env.BITBAKE_THREE }}
        run: |
          if [ "$BITBAKE_THREE" == "empty" ]; then
             echo "BITBAKE_THREE is $BITBAKE_THREE"
          else
             echo "BITBAKE_THREE is $BITBAKE_THREE"
             cd ${{env.WORK_DIR}}
             if [ "$BITBAKE_THREE_ALLOW_ERROR" == "yes" ]; then
                # allow error:
                time ./resy-cooker.sh ${{ steps.yp_config.outputs.yp_config }} ${{ steps.bitbake_three.outputs.bitbake_three }} || true
             else
                # don't allow error:
                time ./resy-cooker.sh ${{ steps.yp_config.outputs.yp_config }} ${{ steps.bitbake_three.outputs.bitbake_three }}
             fi
          fi
        env:
          # export WORKDIR to resy-cooker.sh script:
          WORKDIR: ${{ env.WORK_DIR }}
          WORKSPACE: "jenkins"
          BITBAKE_THREE: ${{ env.BITBAKE_THREE }}
          BITBAKE_THREE_ALLOW_ERROR: ${{ env.BITBAKE_THREE_ALLOW_ERROR }}
#######################################
      - name: bitbake ${{ env.BITBAKE_FOUR }}
        run: |
          if [ "$BITBAKE_FOUR" == "empty" ]; then
             echo "BITBAKE_FOUR is $BITBAKE_FOUR"
          else
             echo "BITBAKE_FOUR is $BITBAKE_FOUR"
             cd ${{env.WORK_DIR}}
             if [ "$BITBAKE_FOUR_ALLOW_ERROR" == "yes" ]; then
                # allow error:
                time ./resy-cooker.sh ${{ steps.yp_config.outputs.yp_config }} ${{ steps.bitbake_four.outputs.bitbake_four }} || true
             else
                # don't allow error:
                time ./resy-cooker.sh ${{ steps.yp_config.outputs.yp_config }} ${{ steps.bitbake_four.outputs.bitbake_four }}
             fi
          fi
        env:
          # export WORKDIR to resy-cooker.sh script:
          WORKDIR: ${{ env.WORK_DIR }}
          WORKSPACE: "jenkins"
          BITBAKE_FOUR: ${{ env.BITBAKE_FOUR }}
          BITBAKE_FOUR_ALLOW_ERROR: ${{ env.BITBAKE_FOUR_ALLOW_ERROR }}
#######################################  
#######################################
      - name: Compress Artifacts after build
        run: |
          if [ ! -d ${{env.WORK_DIR}}/artifacts ];then mkdir -p ${{env.WORK_DIR}}/artifacts ; fi
          pushd ${{env.WORK_DIR}}/artifacts
          set +x
          # 5
          if [ -d ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/conf ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-conf.tar.gz -C ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/conf .; fi
          # cve  images  ipk  licenses  sdk  spdx
          # 
          # 14
          if [ -d ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/cve ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-cve.tar.gz -C ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/cve .; fi
          # 13
          if [ -d ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/images ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-images.tar.gz -C ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/images .; fi
          # 6
          if [ -d ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/ipk ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-ipk.tar.gz -C ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/ipk .; fi
          # 7
          if [ -d ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/licenses ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-licenses.tar.gz -C ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/licenses .; fi
          # 12
          if [ -d ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/sdk ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-sdk.tar.gz -C ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/sdk .; fi
          # 8
          if [ -d ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/spdx ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-spdx.tar.gz -C ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/tmp/deploy/spdx .; fi
          # 4
          if [ -d ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/buildhistory ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-buildhistory.tar.gz -C ${{env.WORK_DIR}}/build/${{ steps.yp_config.outputs.yp_config }}/buildhistory .; fi
          # check also _master
          # 9
          if [ -d ${{env.WORK_DIR}}/downloads_master ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-DL_DIR.tar.gz -C ${{env.WORK_DIR}}/downloads_master .; fi
          if [ -d ${{env.WORK_DIR}}/downloads_${{ steps.yp_version.outputs.yp_version }} ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-DL_DIR.tar.gz -C ${{env.WORK_DIR}}/downloads_${{ steps.yp_version.outputs.yp_version }} .; fi
          # check also _master
          # 11
          if [ -d ${{env.WORK_DIR}}/sstate_master ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-SSTATE_DIR.tar.gz -C ${{env.WORK_DIR}}/sstate_master .; fi
          if [ -d ${{env.WORK_DIR}}/sstate_${{ steps.yp_version.outputs.yp_version }} ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-SSTATE_DIR.tar.gz -C ${{env.WORK_DIR}}/sstate_${{ steps.yp_version.outputs.yp_version }} .; fi
          # check also _master
          # 10
          if [ -d ${{env.WORK_DIR}}/persistent_master ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-PERSISTENT_DIR.tar.gz -C ${{env.WORK_DIR}}/persistent_master .; fi
          if [ -d ${{env.WORK_DIR}}/persistent_${{ steps.yp_version.outputs.yp_version }} ]; then tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-PERSISTENT_DIR.tar.gz -C ${{env.WORK_DIR}}/persistent_${{ steps.yp_version.outputs.yp_version }} .; fi
          set -x
          pwd
          ls -lah ${{env.WORK_DIR}}/artifacts
          popd
#######################################
      - name: Prepare source-mirror
        if: ${{ env.PREP_SOURCE_MIRROR == 'yes' }}
        run: |
          if [ ! -d ${{env.WORK_DIR}}/artifacts ];then mkdir -p ${{env.WORK_DIR}}/artifacts ; fi
          # downloads -> source_mirror
          if [ -d ${{env.WORK_DIR}}/downloads_${{ steps.yp_version.outputs.yp_version }} ]; then
             cp -R ${{env.WORK_DIR}}/downloads_${{ steps.yp_version.outputs.yp_version }} ${{env.WORK_DIR}}/artifacts/source_mirror_${{ steps.yp_version.outputs.yp_version }}
          else
             echo "no ${{env.WORK_DIR}}/downloads_${{ steps.yp_version.outputs.yp_version }}"
          fi
          # take care also about _master
          if [ -d ${{env.WORK_DIR}}/downloads_master ]; then
             cp -R ${{env.WORK_DIR}}/downloads_master ${{env.WORK_DIR}}/artifacts/source_mirror_${{ steps.yp_version.outputs.yp_version }}
          else
             echo "no ${{env.WORK_DIR}}/downloads_master"
          fi
          # cleanup source_mirror
          pushd ${{env.WORK_DIR}}/artifacts/source_mirror_${{ steps.yp_version.outputs.yp_version }}
          ${{env.WORK_DIR}}/sources/${{env.WORKFLOW_DIR}}/cleanup/cleanup.sh
          popd
          # make tarball from source_mirror 
          pushd ${{env.WORK_DIR}}/artifacts
          tar -czf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-source_mirror.tar.gz -C ${{env.WORK_DIR}}/artifacts/source_mirror_${{ steps.yp_version.outputs.yp_version }} .
          # remove source_mirror dir
          rm -rf ${{env.WORK_DIR}}/artifacts/source_mirror_${{ steps.yp_version.outputs.yp_version }}
          popd
####################### --> not supported yet ???
      # - name: Upload Artifact
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: test
      #     path: ${{env.WORK_DIR}}/artifacts
####################### <-- not supported yet ???
      - name: Copy artifacts after build - what is there? (0)
        run: |
          echo "ls ${{env.WORK_DIR}}/artifacts/"
          ls "${{env.WORK_DIR}}/artifacts/"
      # --> conditionally scp what is there
      # --> cp buildhistory conditionally
      - name: Check for file buildhistory
        id: buildhistory_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-buildhistory.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts after build - buildhistory (4)
        if: steps.buildhistory_file_check.outputs.file_exists == 'yes'
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-buildhistory.tar.gz"
          dist: /appdata/artifacts
      # <-- cp buildhistory conditionally
      # --> cp conf conditionally
      - name: Check for file conf
        id: conf_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-conf.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts after build - conf (5)
        if: steps.conf_file_check.outputs.file_exists == 'yes'
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-conf.tar.gz"
          dist: /appdata/artifacts
      # <-- cp conf conditionally
      # --> cp deploy-ipk conditionally
      - name: Check for file deploy-ipk
        id: deploy-ipk_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-ipk.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts after build - deploy-ipk (6)
        if: steps.deploy-ipk_file_check.outputs.file_exists == 'yes'
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-deploy-ipk.tar.gz"
          dist: /appdata/artifacts
      # <-- cp deploy-ipk conditionally
      # --> cp deploy-licenses conditionally    
      - name: Check for file deploy-licenses
        id: deploy-licenses_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-licenses.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts after build - deploy-licenses (7)
        if: steps.deploy-licenses_file_check.outputs.file_exists == 'yes'
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-deploy-licenses.tar.gz"
          dist: /appdata/artifacts
      # <-- cp deploy-licenses conditionally
      # --> cp deploy-spdx conditionally
      - name: Check for file deploy-spdx
        id: deploy-spdx_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-spdx.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts after build - deploy-spdx (8)
        if: steps.deploy-spdx_file_check.outputs.file_exists == 'yes'
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-deploy-spdx.tar.gz"
          dist: /appdata/artifacts
      # <-- cp deploy-spdx conditionally
      # --> cp dl_dir conditionally          
      - name: Check for file dl_dir
        id: dl_dir_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-DL_DIR.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts after build - DL_DIR (9)
        if: steps.dl_dir_file_check.outputs.file_exists == 'yes'
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-DL_DIR.tar.gz"
          dist: /appdata/artifacts
      # <-- cp dl_dir conditionally
      # --> cp persistent_dir conditionally                              
      - name: Check for file persistent_dir
        id: persistent_dir_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-PERSISTENT_DIR.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts after build - PERSISTENT_DIR (10)
        if: steps.persistent_dir_file_check.outputs.file_exists == 'yes'
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-PERSISTENT_DIR.tar.gz"
          dist: /appdata/artifacts
      # <-- cp persistent_dir conditionally
      # --> cp sstate_dir conditionally                              
      - name: Check for file sstate_dir
        id: sstate_dir_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-SSTATE_DIR.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts after build - SSTATE_DIR (11)
        if: steps.sstate_dir_file_check.outputs.file_exists == 'yes'
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-SSTATE_DIR.tar.gz"
          dist: /appdata/artifacts
      # <-- cp sstate_dir conditionally
      # --> cp deploy-sdk_dir conditionally                                                                      
      - name: Check for file deploy-sdk_dir
        id: deploy-sdk_dir_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-sdk.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts after build - deploy-sdk (12)
        if: steps.deploy-sdk_dir_file_check.outputs.file_exists == 'yes'      
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-deploy-sdk.tar.gz"
          dist: /appdata/artifacts
      # <-- cp deploy-sdk_dir conditionally                                                                                
      # --> cp deploy-images_dir conditionally                                                                      
      - name: Check for file deploy-images_dir
        id: deploy-images_dir_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-images.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts after build - deploy-images (13)
        if: steps.deploy-images_dir_file_check.outputs.file_exists == 'yes'      
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-deploy-images.tar.gz"
          dist: /appdata/artifacts
      # <-- cp deploy-sdk_dir conditionally                                                                                
      # --> cp deploy-cve_dir conditionally                                                                      
      - name: Check for file deploy-cve_dir
        id: deploy-cve_dir_file_check
        run: |
          if test -f "${{env.WORK_DIR}}/artifacts/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-cve.tar.gz"; then
            # file exists
            echo "file_exists=yes" >> $GITHUB_OUTPUT
          else
            echo "file_exists=no" >> $GITHUB_OUTPUT
          fi
      - name: Copy artifacts after build - deploy-cve (14)
        if: steps.deploy-cve_dir_file_check.outputs.file_exists == 'yes'      
        uses: youxingz/sshpass-scp-action@v3
        with:
          host: ${{ secrets.SCP_HOST }}
          user: ${{ secrets.SCP_USERNAME }}
          pass: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          src: "${{env.WORK_DIR}}/artifacts/*-deploy-images.tar.gz"
          dist: /appdata/artifacts
      # <-- cp deploy-cve_dir conditionally                                                                                
      # <-- conditionally scp what is there
      - name: Prepare source_mirror_local on server
        if: ${{ env.PREP_SOURCE_MIRROR == 'yes' }}
        uses: https://github.com/appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SCP_HOST }}
          username: ${{ secrets.SCP_USERNAME }}
          password: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          script: |
            if [ ! -d /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }}_compressed ]; then
               mkdir -p /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }}_compressed
            fi
            cp ${{env.ARTIFACTS_ON_SERVER}}/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-source_mirror.tar.gz /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }}_compressed/
            if [ $? -ne 0 ]; then
               exit 1
            fi
            pushd /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }}_compressed/
            # symlink does not seem to work????
            # ln -sf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-source_mirror.tar.gz DL_DIR.tar.gz
            # cp -rf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-source_mirror.tar.gz DL_DIR.tar.gz
            if [ -f DL_DIR.tar.gz ]; then
               rm -f DL_DIR.tar.gz
            fi
            cp ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-source_mirror.tar.gz DL_DIR.tar.gz
            if [ $? -ne 0 ]; then
               exit 2
            fi
            ls -lah
            popd
      - name: Prepare source_mirror on server
        if: ${{ env.PREP_SOURCE_MIRROR == 'yes' }}
        uses: https://github.com/appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SCP_HOST }}
          username: ${{ secrets.SCP_USERNAME }}
          password: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          script: |
            echo "What is here?"
            echo "ls ${{env.ARTIFACTS_ON_SERVER}}/"
            ls ${{env.ARTIFACTS_ON_SERVER}}/
            if [ -d /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }}.ori ]; then
               rm -rf /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }}.ori
            fi
            if [ -d /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }} ]; then
               mv /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }} /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }}.ori
            fi
            mkdir /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }}
            tar -xzf ${{env.ARTIFACTS_ON_SERVER}}/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-source_mirror.tar.gz -C /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }}
            if [ $? -ne 0 ]; then
               exit 1
            fi
            pushd /appdata/lighttpd/var/www/source_mirror_${{ steps.yp_version.outputs.yp_version }}
            echo "${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-source_mirror.tar.gz" > build-version.txt
            ls -lah
            popd
      - name: Populate uninative-tarball on server
        if: ${{ env.POPULATE_UNINATIVE_TARBALL == 'yes' }}
        uses: https://github.com/appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SCP_HOST }}
          username: ${{ secrets.SCP_USERNAME }}
          password: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          script: |
            if [ -d /appdata/lighttpd/var/www/releases/uninative/${{env.UNINATIVE_TARBALL_VERSION}}.ori ]; then
               rm -rf /appdata/lighttpd/var/www/releases/uninative/${{env.UNINATIVE_TARBALL_VERSION}}.ori
            fi
            if [ -d /appdata/lighttpd/var/www/releases/uninative/${{env.UNINATIVE_TARBALL_VERSION}} ]; then
               mv /appdata/lighttpd/var/www/releases/uninative/${{env.UNINATIVE_TARBALL_VERSION}} /appdata/lighttpd/var/www/releases/uninative/${{env.UNINATIVE_TARBALL_VERSION}}.ori
            fi
            pushd ${{env.ARTIFACTS_ON_SERVER}}
              if [ -d deploy-temp ]; then
                 rm -rf deploy-temp
              fi
              mkdir deploy-temp
              tar -xzf ${{env.ARTIFACTS_ON_SERVER}}/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-sdk.tar.gz -C ${{env.ARTIFACTS_ON_SERVER}}/deploy-temp
              pushd deploy-temp
                mkdir -p /appdata/lighttpd/var/www/releases/uninative/${{env.UNINATIVE_TARBALL_VERSION}}
                cp * /appdata/lighttpd/var/www/releases/uninative/${{env.UNINATIVE_TARBALL_VERSION}}/
                pushd /appdata/lighttpd/var/www/releases/uninative/${{env.UNINATIVE_TARBALL_VERSION}}/
                  ln -sf x86_64-nativesdk-libc.tar.xz x86_64-nativesdk-libc-${{env.UNINATIVE_TARBALL_VERSION}}.tar.xz
                  echo "${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-deploy-sdk.tar.gz" > build-version.txt
                  sha256sum=($(sha256sum x86_64-nativesdk-libc-${{env.UNINATIVE_TARBALL_VERSION}}.tar.xz)) && echo ${sha256sum} > sha256sum.txt
                  cat sha256sum.txt
                  ls -lah
                popd
              popd
            popd
      - name: Populate sstate_mirror on server
        if: ${{ env.POPULATE_SSTATE_MIRROR == 'yes' }}
        uses: https://github.com/appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SCP_HOST }}
          username: ${{ secrets.SCP_USERNAME }}
          password: ${{ secrets.SCP_PASSWORD }}
          port: ${{ secrets.SCP_PORT }}
          script: |
            if [ -d /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }}.ori ]; then
              rm -rf /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }}.ori
            fi
            if [ -d /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }} ]; then
              mv /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }} /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }}.ori
            fi
            mkdir -p /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }}
            tar -xzf ${{env.ARTIFACTS_ON_SERVER}}/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-SSTATE_DIR.tar.gz -C /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }}
            pushd /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }}
            echo "${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-SSTATE_DIR.tar.gz" > build-version.txt
            ls -lah
            popd
            # !!!!! create sstate_mirror_compressed !!!!!
            if [ ! -d /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }}_compressed ]; then
               mkdir -p /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }}_compressed
            fi
            cp ${{env.ARTIFACTS_ON_SERVER}}/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-SSTATE_DIR.tar.gz ${{env.ARTIFACTS_ON_SERVER}}/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-sstate_mirror.tar.gz
            if [ $? -ne 0 ]; then
               exit 1
            fi
            cp ${{env.ARTIFACTS_ON_SERVER}}/${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-sstate_mirror.tar.gz /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }}_compressed/
            if [ $? -ne 0 ]; then
               exit 2
            fi
            pushd /appdata/lighttpd/var/www/sstate_mirror_${{ steps.yp_version.outputs.yp_version }}_compressed/
            # symlink does not seem to work????
            # ln -sf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-sstate_mirror.tar.gz SSTATE_DIR.tar.gz
            # cp -rf ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-sstate_mirror.tar.gz SSTATE_DIR.tar.gz
            if [ -f SSTATE_DIR.tar.gz ]; then
               rm -f SSTATE_DIR.tar.gz
            fi
            cp ${{ steps.date.outputs.date }}-${{ steps.note.outputs.note }}-${{ steps.yp_config.outputs.yp_config }}-sstate_mirror.tar.gz SSTATE_DIR.tar.gz
            if [ $? -ne 0 ]; then
               exit 3
            fi
            ls -lah
            popd
      - name: Finished 02-uninative-local-source-mirror.yml
        id: finished_02
        run: |
          echo "Finished 02-uninative-local-source-mirror.yml"
